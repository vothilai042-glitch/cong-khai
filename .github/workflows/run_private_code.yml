name: "Run Private Code (YouTube)"

on:
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: run-private-code
  cancel-in-progress: false

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # 1) L·∫•y repo ri√™ng t∆∞ v·ªÅ th∆∞ m·ª•c private-src/
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          repository: ${{ secrets.PRIVATE_REPO_REPOSITORY }}   # v√≠ d·ª•: org/private-repo
          token: ${{ secrets.PRIVATE_REPO_TOKEN }}             # token c√≥ quy·ªÅn read (n·∫øu push th√¨ c·∫ßn write)
          ref: main
          path: private-src
          fetch-depth: 1
          persist-credentials: false

      # 2) Pre-sync: h·ª£p nh·∫•t tieudedalay.csv v√†o m·ªçi v·ªã tr√≠ c√≥ th·ªÉ ƒë∆∞·ª£c main.py d√πng
      - name: Pre-sync tieudedalay.csv (normalize locations)
        run: |
          set -e
          # C√°c kh·∫£ nƒÉng s·∫µn c√≥:
          ROOT_WS=./tieudedalay.csv
          PRIV_ROOT=private-src/tieudedalay.csv
          PRIV_SRC=private-src/src/tieudedalay.csv

          pick_src=""
          if   [ -f "$PRIV_SRC"  ]; then pick_src="$PRIV_SRC"
          elif [ -f "$PRIV_ROOT" ]; then pick_src="$PRIV_ROOT"
          elif [ -f "$ROOT_WS"   ]; then pick_src="$ROOT_WS"
          fi

          # N·∫øu c√≥ file ·ªü b·∫•t k·ª≥ n∆°i n√†o ‚Üí tr·∫£i ƒë·ªÅu cho 3 n∆°i
          if [ -n "$pick_src" ]; then
            echo "[INFO] Seed tieudedalay from: $pick_src"
            cp "$pick_src" "$ROOT_WS"    || true
            mkdir -p private-src/src
            cp "$pick_src" "$PRIV_ROOT"  || true
            cp "$pick_src" "$PRIV_SRC"   || true
          else
            echo "[INFO] No existing tieudedalay.csv found (first run is fine)."
          fi

      # 3) Python
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      # 4) G√≥i h·ªá th·ªëng
      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 fonts-dejavu-core

      - name: Provision 10GB swap (avoid OOM)
        run: |
          sudo fallocate -l 10G /swapfile
          sudo chmod 600 /swapfile
          sudo mkswap /swapfile
          sudo swapon /swapfile
          sudo sysctl vm.swappiness=60
          echo "[INFO] Swap on:"
          swapon --show


      # 5) Python deps
      - name: Install Python deps
        working-directory: private-src
        run: |
          python -m pip install --upgrade pip
          pip install --index-url https://download.pytorch.org/whl/cpu "torch==2.4.*" "torchaudio==2.4.*"
          pip install "TTS==0.22.0" "transformers==4.44.2" "huggingface_hub<0.34" pillow soundfile numpy requests tqdm underthesea vinorm google-genai
          pip install "google-api-python-client" "google-auth" "google-auth-oauthlib"

      # 6) Ch·∫°y main.py trong repo ri√™ng t∆∞ ‚Äî c·∫ßn 4 secrets b·∫Øt bu·ªôc ·ªü repo c√¥ng khai
      - name: Run main.py (video + thumb + append tieudedalay.csv)
        working-directory: private-src
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          YT_CLIENT_ID: ${{ secrets.YT_CLIENT_ID }}
          YT_CLIENT_SECRET: ${{ secrets.YT_CLIENT_SECRET }}
          YT_REFRESH_TOKEN: ${{ secrets.YT_REFRESH_TOKEN }}

          # ----- t·ªëc ƒë·ªô & ch·∫•t l∆∞·ª£ng -----
          # B·∫¨T turbo nhanh nh·∫•t (soft-sub, kh√¥ng burn):
          FAST_MODE: "0"              # "1" = soft-sub, "0" = burn ph·ª• ƒë·ªÅ
          OUT_FPS: "15"               # 15fps ƒë·ªß m∆∞·ª£t cho slideshow, gi·∫£m 50% kh·ªëi l∆∞·ª£ng render
          X264_PRESET: "ultrafast"    # nhanh nh·∫•t; n·∫øu mu·ªën ƒë·∫πp h∆°n d√πng "veryfast" ho·∫∑c "faster"
          FAST_AUDIO: "1"             # h·∫≠u k·ª≥ nh·∫π (ch·ªâ loudnorm)

          TARGET_AUDIO_SEC: "3600"
          INIT_TARGET_CHARS: "5000"
          INIT_TARGET_SEC_HINT: "300"

          # S√°ng t·∫°o + ch·ªëng l·∫∑p cho Gemini
          GEN_TEMP: "1.1"                 # 1.0‚Äì1.1: s√°ng t·∫°o/·ªïn ƒë·ªãnh
          GEN_TOP_P: "0.80"
          NOVEL_MIN_DETAILS: "7"           # m·ªói ch∆∞∆°ng 10 chi ti·∫øt m·ªõi
          NO_REPEAT_CONTEXT_CHARS: "3000"  # ƒë·ªçc l·∫°i 3000 k√Ω t·ª± g·∫ßn nh·∫•t
          DO_NOT_REPEAT_MAX: "40"          # t·ªëi ƒëa 40 c√¢u c·∫•m l·∫∑p

          TOP_K: "1"
          TOP_P: "0.45"
          R_PEN: "8.0"
          L_PEN: "1.05"
          CHUNK_MAX_CHARS: "150"
          SENTENCE_PAUSE_MS: "50"

          IMG_W: "1280"
          IMG_H: "720"
          POLL_IMG_MODEL: "flux-anime"
          IMG_RATE_SEC: "1.5"
          IMG_TIMEOUT_SEC: "15"

          YOUTUBE_PRIVACY: public
          PYTHONUNBUFFERED: "1"

          # XTTS & threading
          TORCH_NUM_THREADS: "2"
          OMP_NUM_THREADS: "2"
          MKL_NUM_THREADS: "2"
          OPENBLAS_NUM_THREADS: "2"
          NUMEXPR_NUM_THREADS: "2"

          # üëá TH√äM 2 D√íNG N√ÄY
          GENAI_MAX_RETRIES: "9"
          GENAI_BACKOFF_BASE: "2.0"
        
        run: |
          set -Eeuo pipefail
          if [ -f "src/main.py" ]; then
            echo "[RUN] python src/main.py"
            python src/main.py
          else
            echo "[RUN] python main.py"
            python main.py
          fi

      # 7) Post-sync: gom tieudedalay.csv t·ª´ n∆°i main.py c√≥ th·ªÉ ƒë√£ ghi ‚Üí ƒë∆∞a v·ªÅ private-src root + src
      - name: Post-sync tieudedalay.csv (collect & normalize)
        run: |
          set -e
          ROOT_WS=./tieudedalay.csv
          PRIV_ROOT=private-src/tieudedalay.csv
          PRIV_SRC=private-src/src/tieudedalay.csv

          # ∆Øu ti√™n file m·ªõi nh·∫•t n·∫øu c√≥ nhi·ªÅu b·∫£n
          newest=""
          for f in "$ROOT_WS" "$PRIV_SRC" "$PRIV_ROOT"; do
            if [ -f "$f" ]; then
              if [ -z "$newest" ]; then
                newest="$f"
              else
                # so s√°nh mtime
                if [ "$f" -nt "$newest" ]; then newest="$f"; fi
              fi
            fi
          done

          if [ -n "$newest" ]; then
            echo "[INFO] Normalize from newest: $newest"
            cp "$newest" "$ROOT_WS"   || true
            cp "$newest" "$PRIV_ROOT" || true
            cp "$newest" "$PRIV_SRC"  || true
          else
            echo "[INFO] No tieudedalay.csv produced."
          fi

      # 8) Commit & push v·ªÅ repo ri√™ng t∆∞ (n·∫øu token c√≥ quy·ªÅn ghi)
      - name: Commit & push tieudedalay.csv back to PRIVATE
        working-directory: private-src
        env:
          TOKEN: ${{ secrets.PRIVATE_REPO_TOKEN }}
          REPO: ${{ secrets.PRIVATE_REPO_REPOSITORY }}
        run: |
          set -e
          if [ -z "$TOKEN" ]; then
            echo "[INFO] No PRIVATE_REPO_TOKEN ‚Üí skip push."
            exit 0
          fi

          # ƒë·∫£m b·∫£o ƒëang ·ªü nh√°nh main v√† up-to-date
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git remote set-url origin "https://x-access-token:${TOKEN}@github.com/${REPO}.git"
          git fetch origin main || true
          git checkout -B main || true
          git pull --rebase origin main || true

          # add c·∫£ 2 v·ªã tr√≠ kh·∫£ dƒ©
          git add tieudedalay.csv src/tieudedalay.csv .state/* 2>/dev/null || true
          git diff --cached --quiet && { echo "[INFO] No changes to commit."; exit 0; }
          git commit -m "ci(state): update tieudedalay.csv"
          git push origin HEAD:main
